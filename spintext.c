#include <stdio.h>
#include <string.h>
#include <math.h>
#include <unistd.h>
#include <ctype.h>
#include <stdlib.h>
#include <signal.h>

#define WIDTH 200
#define HEIGHT 60
#define CAMERA_DISTANCE 10.0
#define LUT_SIZE 360

float sin_lut[LUT_SIZE];
float cos_lut[LUT_SIZE];
float zbuffer[WIDTH * HEIGHT];
char buffer[WIDTH * HEIGHT];

int font[36][5][5] = {
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {1, 1, 1, 1, 1}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}}, // A
	{{1, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {1, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {1, 1, 1, 1, 0}}, // B
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 0}, {1, 0, 0, 0, 0}, {1, 0, 0, 0, 0}, {0, 1, 1, 1, 0}}, // C
	{{1, 1, 1, 0, 0}, {1, 0, 0, 1, 0}, {1, 0, 0, 1, 0}, {1, 0, 0, 1, 0}, {1, 1, 1, 0, 0}}, // D
	{{1, 1, 1, 1, 1}, {1, 0, 0, 0, 0}, {1, 1, 1, 1, 0}, {1, 0, 0, 0, 0}, {1, 1, 1, 1, 1}}, // E
	{{1, 1, 1, 1, 1}, {1, 0, 0, 0, 0}, {1, 1, 1, 0, 0}, {1, 0, 0, 0, 0}, {1, 0, 0, 0, 0}}, // F
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 0}, {1, 0, 0, 1, 1}, {1, 0, 0, 0, 1}, {0, 1, 1, 1, 0}}, // G
	{{1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 1, 1, 1, 1}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}}, // H
	{{0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}}, // I
	{{0, 0, 1, 1, 1}, {0, 0, 0, 1, 0}, {0, 0, 0, 1, 0}, {1, 0, 0, 1, 0}, {0, 1, 1, 0, 0}}, // J
	{{1, 0, 0, 0, 1}, {1, 0, 0, 1, 0}, {1, 1, 1, 0, 0}, {1, 0, 0, 1, 0}, {1, 0, 0, 0, 1}}, // K
	{{1, 0, 0, 0, 0}, {1, 0, 0, 0, 0}, {1, 0, 0, 0, 0}, {1, 0, 0, 0, 0}, {1, 1, 1, 1, 1}}, // L
	{{1, 0, 0, 0, 1}, {1, 1, 0, 1, 1}, {1, 0, 1, 0, 1}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}}, // M
	{{1, 0, 0, 0, 1}, {1, 1, 0, 0, 1}, {1, 0, 1, 0, 1}, {1, 0, 0, 1, 1}, {1, 0, 0, 0, 1}}, // N
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {0, 1, 1, 1, 0}}, // O
	{{1, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {1, 1, 1, 1, 0}, {1, 0, 0, 0, 0}, {1, 0, 0, 0, 0}}, // P
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 0, 0, 1, 0}, {0, 1, 1, 0, 1}}, // Q
	{{1, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 1, 1, 1, 0}, {1, 0, 0, 0, 1}}, // R
	{{0, 1, 1, 1, 1}, {1, 0, 0, 0, 0}, {0, 1, 1, 1, 0}, {0, 0, 0, 0, 1}, {1, 1, 1, 1, 0}}, // S
	{{1, 1, 1, 1, 1}, {0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}}, // T
	{{1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {0, 1, 1, 1, 0}}, // U
	{{1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {0, 1, 0, 1, 0}, {0, 0, 1, 0, 0}}, // V
	{{1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 0, 1, 0, 1}, {1, 0, 1, 0, 1}, {0, 1, 0, 1, 0}}, // W
	{{1, 0, 0, 0, 1}, {0, 1, 0, 1, 0}, {0, 0, 1, 0, 0}, {0, 1, 0, 1, 0}, {1, 0, 0, 0, 1}}, // X
	{{1, 0, 0, 0, 1}, {0, 1, 0, 1, 0}, {0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}}, // Y
	{{1, 1, 1, 1, 1}, {0, 0, 0, 1, 0}, {0, 0, 1, 0, 0}, {0, 1, 0, 0, 0}, {1, 1, 1, 1, 1}}, // Z
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {0, 1, 1, 1, 0}}, // 0
	{{0, 0, 1, 0, 0}, {0, 1, 1, 0, 0}, {0, 0, 1, 0, 0}, {0, 0, 1, 0, 0}, {0, 1, 1, 1, 0}}, // 1
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {0, 0, 0, 1, 0}, {0, 0, 1, 0, 0}, {1, 1, 1, 1, 1}}, // 2
	{{1, 1, 1, 1, 0}, {0, 0, 0, 0, 1}, {0, 1, 1, 1, 0}, {0, 0, 0, 0, 1}, {1, 1, 1, 1, 0}}, // 3
	{{1, 0, 0, 0, 1}, {1, 0, 0, 0, 1}, {1, 1, 1, 1, 1}, {0, 0, 0, 0, 1}, {0, 0, 0, 0, 1}}, // 4
	{{1, 1, 1, 1, 1}, {1, 0, 0, 0, 0}, {1, 1, 1, 1, 0}, {0, 0, 0, 0, 1}, {1, 1, 1, 1, 0}}, // 5
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 0}, {1, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {0, 1, 1, 1, 0}}, // 6
	{{1, 1, 1, 1, 1}, {0, 0, 0, 0, 1}, {0, 0, 0, 1, 0}, {0, 0, 1, 0, 0}, {0, 1, 0, 0, 0}}, // 7
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {0, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {0, 1, 1, 1, 0}}, // 8
	{{0, 1, 1, 1, 0}, {1, 0, 0, 0, 1}, {0, 1, 1, 1, 1}, {0, 0, 0, 0, 1}, {0, 1, 1, 1, 0}}  // 9
};

void handle_sigint(int sig) {
	printf("\x1b[?25h\x1b[33m\nTerminating with code\x1b[35m %d\n\x1b[0m", sig);
	exit(0);
}

int main(int argc, char *argv[]) {
	signal(SIGINT, handle_sigint);
	char *text = (argc <= 1) ? "CORGI" : argv[1];
	float tilt = (argc <= 2) ? 1.0f : strtof(argv[2], NULL);
	float spin = (argc <= 3) ? 1.0f : strtof(argv[3], NULL);
	float roll = (argc <= 4) ? 1.0f : strtof(argv[4], NULL);
	char shades[] = ".,-~:;=!*#$@";
	// shade map uses list of (colour code, effect), but because some dont really need effects, it uses 25 (blink off) which is just a useless variable in this case.
	int shade_map[][2] = {{22, 2}, {22, 2}, {22, 2}, {34, 2}, {34, 25}, {34, 25}, {40, 25}, {40, 25}, {40, 1}, {46, 1}, {46, 1}, {46, 1}}; // standard ansi shademap
	int len = strlen(text);

	float zoom_x = 1000.0 / (len + 1.0);
	float zoom_y = 500.0 / (len + 1.0);

	for (int i = 0; i < LUT_SIZE; i++) {
		sin_lut[i] = sin(i * 0.017453f);
		cos_lut[i] = cos(i * 0.017453f);
	}

	float A = 0, B = 0, C = 0;

	while (1) {
		memset(buffer, ' ', WIDTH * HEIGHT);
		memset(zbuffer, 0, WIDTH * HEIGHT * sizeof(float));

		for (int l = 0; l < len; l++) {
			char ch = toupper(text[l]);
			int idx = -1;
			if (ch >= 'A' && ch <= 'Z') {
				idx = ch - 'A';
			} else if (ch >= '0' && ch <= '9') {
				idx = (ch - '0') + 26;
			}
			if (idx < 0 || idx > 35) continue;

			for (int y = 0; y < 5; y++) {
				for (int x = 0; x < 5; x++) {
					if (font[idx][y][x]) {
						for (float z = -0.2; z <= 0.2; z += 0.08) {
							for (float fx = 0.0; fx < 1.0; fx += 0.08) {
								for (float fy = 0.0; fy < 1.0; fy += 0.08) {
									float offset = (len * 6.0) / 2.0;
									float px = (x + fx) + (l * 6.0) - offset;
									float py = (y + fy) - 2.5;
									float pz = z;

									int iA = (A >= 0.0) ? (int) A % 360 : (int) ((int) A % 360) + 360.0;
									int iB = (B >= 0.0) ? (int) B % 360 : (int) ((int) B % 360) + 360.0;
									int iC = (C >= 0.0) ? (int) C % 360 : (int) ((int) C % 360) + 360.0;

									float y1 = py * cos_lut[iA] - pz * sin_lut[iA];
									float z1 = py * sin_lut[iA] + pz * cos_lut[iA];
									float x2 = px * cos_lut[iB] + z1 * sin_lut[iB];
									float z2 = -px * sin_lut[iB] + z1 * cos_lut[iB];
									float x3 = x2 * cos_lut[iC] - y1 * sin_lut[iC];
									float y3 = x2 * sin_lut[iC] + y1 * cos_lut[iC];

									float camera_dist = CAMERA_DISTANCE + (len * 5.0);
									float ooz = 1.0 / (z2 + camera_dist);

									int xp = (int) (WIDTH / 2 + zoom_x * ooz * x3);
									int yp = (int) (HEIGHT / 2 + zoom_y * ooz * y3);

									if (xp >= 0 && xp < WIDTH && yp >= 0 && yp < HEIGHT) {
										int loc = yp * WIDTH + xp;
										if (ooz > zbuffer[loc]) {
											zbuffer[loc] = ooz;
											int max_shade = 16;
											int L = (int) ((12.0 - (z2 * 0.5)) * 0.8);
											if (L < 0) L = 0;
											if (L > 11) L = 11;
											if (L > max_shade) L = max_shade;

											buffer[loc] = shades[L];
										}
									}
								}
							}
						}
					}
				}
			}
		} // holy this is a lot of loops ending

		printf("\x1b[H\x1b[?25l");
		for (int k = 0; k < WIDTH * HEIGHT; k++) {
			if (k > 0 && k % WIDTH == 0) printf("\x1b[0m\n");
			printf("\x1b[0m");

			char *ptr = strchr(shades, buffer[k]);
			int idx = ptr ? (int) (ptr - shades) : 0;
			idx = (idx > 11) ? 11 : idx;

			printf("\x1b[38;5;%d;%dm%c", shade_map[idx][0], shade_map[idx][1], buffer[k]);
		}
		printf("\x1b[0m");

		A += tilt;
		B += spin;
		C += roll;

		usleep(25000);
	}
	return 0;
}
